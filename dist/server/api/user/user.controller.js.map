{"version":3,"sources":["api/user/user.controller.js"],"names":["index","create","show","destroy","changePassword","me","signupvalid","authCallback","userNew","validationError","res","statusCode","err","status","json","handleError","send","req","find","exec","then","users","catch","console","log","headers","originalUrl","newUser","body","provider","role","save","user","token","sign","_id","secrets","session","expiresIn","activeToken","true","next","userId","params","id","findById","end","profile","findByIdAndRemove","oldPass","String","oldPassword","newPass","newPassword","authenticate","password","findOne","isAtivo","redirect"],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\n\nimport User from './user.model';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\nimport * as userNew from '../../mailer/userNew.service';\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    return res.status(statusCode).json(err);\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    return res.status(statusCode).send(err);\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexport function index(req, res) {\n  return User.find({}, '-salt -password').exec()\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexport function create(req, res) {\n  console.log('req.headers[user-agent]', req.headers['user-agent']);\n  console.log('req.headers[origin]', req.headers['origin']);\n  console.log('req.originalUrl', req.originalUrl);\n\n  var newUser = new User(req.body);\n  console.log(userNew);\n  newUser.provider = 'local';\n  newUser.role = 'user';\n  newUser.save()\n    .then(function(user) {\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n        expiresIn: 60 * 60 * 5\n      });\n      user.activeToken = token;\n      user.save()\n        .then(() => {\n          //res.status(204).end();\n          res.json({ true });\n          userNew.send(req, user);\n          return user;\n        })\n        .catch(validationError(res));\n      return user;\n    })\n    .catch(validationError(res));\n}\n\n/**\n * Get a single user\n */\nexport function show(req, res, next) {\n  var userId = req.params.id;\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n      return user;\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexport function destroy(req, res) {\n  return User.findByIdAndRemove(req.params.id).exec()\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Change a users password\n */\nexport function changePassword(req, res) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.save()\n          .then(() => {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n}\n\n/**\n * Get my info\n */\nexport function me(req, res, next) {\n  var userId = req.user._id;\n\n  return User.findOne({ _id: userId }, '-salt -password -activeToken').exec()\n    .then(user => { // don't ever give out the password or salt\n      if(!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n      return user;\n    })\n    .catch(err => next(err));\n}\n\nexport function signupvalid(req, res) {\n  var token = String(req.body.token);\n  return User.findOne({ activeToken: token }, '-salt -password').exec()\n    .then(user => { // don't ever give out the password or salt\n      if(!user) {\n        return res.status(401).end();\n      }\n      user.activeToken = null;\n      user.isAtivo = true;\n      user.save();\n      //res.json(user);\n      res.json({ token });\n      return user;\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Authentication callback\n */\nexport function authCallback(req, res) {\n  res.redirect('/');\n}\n"]}